<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Football!</title>
  </head>
  <body>
    <!-- GrÃ¡fico dentro de un iframe -->
    <iframe 
        id="nfl-frame"
        src="NFL_Teams_Chart4.html" 
        width="100%" 
        height="900px" 
        style="border:none;">
    </iframe>

    <script src="https://app.protobject.com/framework/p.js"></script>
    <script src="config.js"></script>

    <script>
      window.addEventListener("load", () => {

        const iframe = document.getElementById("nfl-frame");

        function clickBarByIndex(barIndex) {
          if (!iframe || !iframe.contentWindow) return;

          const w = iframe.contentWindow;
          const Plotly = w.Plotly;
          if (!Plotly || !Plotly.Fx) return;

          const graphDiv = w.document.querySelector(".plotly-graph-div");
          if (!graphDiv) return;

          // Simula un click de Plotly en esa barra
          Plotly.Fx.click(graphDiv, {
            curveNumber: 0,
            pointNumber: barIndex
          });
        }

        function normToBarIndex(norm) {
          if (!iframe || !iframe.contentWindow) return 0;

          const w = iframe.contentWindow;
          const graphDiv = w.document.querySelector(".plotly-graph-div");
          if (!graphDiv || !graphDiv.data || !graphDiv.data[0]) return 0;

          const nBars = graphDiv.data[0].y.length;

          // Ajusta estos valores viendo los logs del telÃ©fono
          const minNorm = 8;
          const maxNorm = 20;

          const clamped = Math.max(minNorm, Math.min(maxNorm, norm));
          const t = (clamped - minNorm) / (maxNorm - minNorm);

          let idx = Math.floor(t * (nBars - 1));
          return Math.max(0, Math.min(idx, nBars - 1));
        }

        function handleAccelerationMessage(message) {
          if (!message) return;

          if (message.type === "acceleration" && typeof message.norm === "number") {
            const index = normToBarIndex(message.norm);
            console.log("âž¡ Seleccionar barra:", index, "norm:", message.norm);
            clickBarByIndex(index);
          }
        }

        // ðŸ‘‰ Listener oficial de Protobject para recibir mensajes
        Protobject.Core.onReceived(function (message) {
          console.log("ðŸ“© Mensaje recibido en Knob:", message);
          handleAccelerationMessage(message);
        });

        console.log("ðŸ“¡ Listo para recibir acelerÃ³metro desde el telÃ©fono.");
      });
    </script>
  </body>
</html>


 