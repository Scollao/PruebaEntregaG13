<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Football!</title>
  </head>
  <body>
    <!-- Gr√°fico dentro de un iframe -->
    <iframe 
        id="nfl-frame"
        src="NFL_Teams_Chart4.html" 
        width="100%" 
        height="900px" 
        style="border:none;">
    </iframe>

    <script src="https://app.protobject.com/framework/p.js"></script>
    <script src="config.js"></script>

    <script>
      window.addEventListener("load", () => {

        const iframe = document.getElementById("nfl-frame");

        // üëá SOLO CAMBIAMOS ESTA FUNCI√ìN
        function clickBarByIndex(barIndex) {
          if (!iframe || !iframe.contentWindow) return;

          const w   = iframe.contentWindow;
          const doc = w.document;
          const graphDiv = doc.querySelector(".plotly-graph-div");
          if (!graphDiv) {
            console.warn("No se encontr√≥ .plotly-graph-div dentro del iframe");
            return;
          }

          // Obtener TODAS las barras que tengan data-point-number
          const barNodes = graphDiv.querySelectorAll("[data-point-number]");
          console.log("üîé Barras encontradas con data-point-number:", barNodes.length);

          if (!barNodes.length) {
            console.warn("No se encontraron elementos con data-point-number");
            return;
          }

          // Aseguramos que el √≠ndice no se salga del rango
          const safeIndex = Math.max(0, Math.min(barIndex, barNodes.length - 1));
          const bar = barNodes[safeIndex];

          if (!bar) {
            console.warn("No existe barra con √≠ndice", safeIndex);
            return;
          }

          console.log("üñ± Haciendo click en barra con index:", safeIndex, "elemento:", bar);

          // Crear y despachar un evento de click como si fuera el mouse
          const evt = new MouseEvent("click", {
            bubbles: true,
            cancelable: true,
            view: w
          });

          bar.dispatchEvent(evt);
        }

        // üëÜ HASTA AQU√ç EL CAMBIO

        function accelToChamp(norm) {
          const minNorm = 10;   // ajusta si hace falta
          const maxNorm = 50;  // ajusta si hace falta

          // Recortamos la norma al rango [minNorm, maxNorm]
          const clamped = Math.max(minNorm, Math.min(maxNorm, norm));

          // Normalizamos a 0..13 en lugar de 0..1
          const t = (clamped - minNorm) / (maxNorm - minNorm); // 0..1
          const champEquivalent = t * 13;                       // 0..13

          // Valores v√°lidos de championships
          const allowed = [13, 9, 8, 6, 5, 4, 3, 2, 1, 0];

          // Queremos el MAYOR allowed <= champEquivalent
          for (let v of allowed) {
            if (champEquivalent >= v) {
              return v;   // primera coincidencia hacia abajo
            }
          }

          // Si por alguna raz√≥n nada cumple, devolvemos 0
          return 0;
        }

        function normToBarIndex(norm) {
          if (!iframe || !iframe.contentWindow) return 0;

          const w = iframe.contentWindow;
          const graphDiv = w.document.querySelector(".plotly-graph-div");
          if (!graphDiv || !graphDiv.data || !graphDiv.data[0]) return 0;

          const data = graphDiv.data[0];

          // En tu barplot horizontal, x son los championships (Chmp)
          const champsArray = data.x;   // [13, 9, 6, 6, 5, 5, 5, 4, ...] por ejemplo

          // 1) convertir norma a n√∫mero de championships
          const targetChamp = accelToChamp(norm);
          console.log("norm:", norm, "‚Üí champ equivalente:", targetChamp);

          // 2) buscar el PRIMER equipo con ese n√∫mero de championships
          let idx = 0;  // fallback
          for (let i = 0; i < champsArray.length; i++) {
            if (Number(champsArray[i]) === targetChamp) {
              idx = i;
              break;   // el primero que aparezca
            }
          }

          return idx;
        } 

        function handleAccelerationMessage(message) {
          if (!message) return;

          if (message.type === "acceleration" && typeof message.norm === "number") {
            const norma = normToBarIndex(message.norm);
            console.log("Seleccionar barra: ", norma, "  norm:", message.norm);
            clickBarByIndex(norma);
          }
        }

        // üëâ Listener oficial de Protobject para recibir mensajes
        Protobject.Core.onReceived(function (message) {
          console.log("üì© Mensaje recibido en Knob:", message);
          handleAccelerationMessage(message);
        });

        console.log("üì° Listo para recibir aceler√≥metro desde el tel√©fono.");
      });
    </script>
  </body>
</html>



 